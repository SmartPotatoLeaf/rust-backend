use crate::adapters::web::models::diagnostics::{
    prediction_mark::{PredictionMarkResponse, RawPredictionMarkResponse},
    LabelResponse, SimplifiedLabelResponse,
};
use crate::adapters::web::models::feedback::{FeedbackResponse, SimplifiedFeedbackResponse};
use crate::adapters::web::models::image::{ImageResponse, RawImageResponse};
use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use spl_shared::validation::validate_range_min_max;
use utoipa::ToSchema;
use uuid::Uuid;
use validator::{Validate, ValidationError};
use crate::adapters::web::models::diagnostics::label::RawLabelResponse;

#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]
pub struct PredictionResponse {
    /// Unique identifier of the prediction
    pub id: Uuid,
    /// User who created the prediction
    pub user_id: Uuid,
    /// Confidence level for disease presence (0.0 to 1.0)
    pub presence_confidence: f32,
    /// Confidence level for disease absence (0.0 to 1.0)
    pub absence_confidence: f32,
    /// Disease severity percentage (0.0 to 100.0)
    pub severity: f32,
    /// Timestamp when the prediction was created
    pub created_at: DateTime<Utc>,
    /// Optional plot ID where this prediction is assigned
    pub plot_id: Option<Uuid>,
    /// Image information used for the prediction
    pub image: ImageResponse,
    /// Predicted disease label
    pub label: LabelResponse,
    /// Segmentation marks (masks) generated by the model
    pub marks: Vec<PredictionMarkResponse>,
    /// User feedback on the prediction accuracy
    pub feedback: Option<FeedbackResponse>,
}

#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]
pub struct SimplifiedPredictionResponse {
    /// Unique identifier of the prediction
    pub id: Uuid,
    /// User who created the prediction
    pub user_id: Uuid,
    /// Confidence level for disease presence (0.0 to 1.0)
    pub presence_confidence: f32,
    /// Confidence level for disease absence (0.0 to 1.0)
    pub absence_confidence: f32,
    /// Disease severity percentage (0.0 to 100.0)
    pub severity: f32,
    /// Predicted disease label (simplified)
    pub label: SimplifiedLabelResponse,
    /// Optional plot ID where this prediction is assigned
    pub plot_id: Option<Uuid>,
    /// Image information used for the prediction
    pub image: ImageResponse,
    /// Segmentation marks (masks) generated by the model
    pub marks: Vec<PredictionMarkResponse>,
    /// User feedback on the prediction accuracy (simplified)
    pub feedback: Option<SimplifiedFeedbackResponse>,
    /// Timestamp when the prediction was created
    pub created_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize, Validate, ToSchema)]
#[validate(schema(function = "validate_filter_predictions"))]
pub struct FilterPredictionsRequest {
    /// Filter by company ID
    pub company_id: Option<Uuid>,
    /// Filter by specific user IDs
    pub user_ids: Option<Vec<Uuid>>,
    /// Filter by disease label names
    pub labels: Option<Vec<String>>,
    /// Filter by plot IDs (None for unassigned)
    pub plot_ids: Option<Vec<Option<Uuid>>>,
    /// Filter predictions created after this date
    pub min_date: Option<DateTime<Utc>>,
    /// Filter predictions created before this date
    pub max_date: Option<DateTime<Utc>>,
    /// Maximum number of items per page (1-100)
    #[validate(range(min = 1, max = 100))]
    pub limit: Option<u64>,
    /// Page number (1-indexed)
    #[validate(range(min = 1))]
    pub page: Option<u64>,
}

fn validate_filter_predictions(req: &FilterPredictionsRequest) -> Result<(), ValidationError> {
    if let (Some(min), Some(max)) = (req.min_date, req.max_date) {
        validate_range_min_max(min, max)?;
    }
    Ok(())
}

#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]
pub struct PredictionsListResponse {
    /// Total number of predictions matching the filter
    pub total: u64,
    /// Current page number
    pub page: u64,
    /// Number of items per page
    pub limit: u64,
    /// List of prediction records
    pub items: Vec<PredictionResponse>,
}

#[derive(ToSchema)]
pub struct CreatePredictionRequest {
    /// Image file to analyze (JPEG/PNG)
    #[schema(value_type = String, format = Binary)]
    pub file: Vec<u8>,
}

#[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]
pub struct RawPredictionResponse {
    /// Confidence level for disease presence (0.0 to 1.0)
    pub presence_confidence: f32,
    /// Confidence level for disease absence (0.0 to 1.0)
    pub absence_confidence: f32,
    /// Disease severity percentage (0.0 to 100.0)
    pub severity: f32,
    /// Timestamp when the prediction was created
    pub created_at: DateTime<Utc>,
    /// Image data with base64 encoded content
    pub image: RawImageResponse,
    /// Predicted disease label information
    pub label: RawLabelResponse,
    /// Segmentation marks (masks) with base64 encoded data
    pub marks: Vec<RawPredictionMarkResponse>,
}
